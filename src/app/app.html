<div class="container">
  <h1>ğŸ’° AMIGOS Expense Tracker</h1>

  <!-- SECTION 1: Add Users -->
  <div class="section">
    <h2>ğŸ‘¥ Add Users</h2>
    <div class="add-user-form">
      <input 
        type="text" 
        [(ngModel)]="newUserName" 
        placeholder="Enter user name"
        (keyup.enter)="addUser()"
        class="input"
      />
      <button (click)="addUser()" class="btn btn-primary">Add User</button>
    </div>

    @if (users.length > 0) {
      <div class="users-list">
        <h3>Users ({{ users.length }})</h3>
        @for (user of users; track user.id) {
          <div class="user-chip">
            <span>{{ user.name }}</span>
            <button (click)="removeUser(user.id)" class="btn-remove">Ã—</button>
          </div>
        }
      </div>
    } @else {
      <p class="empty-message">No users added yet. Add users to start tracking expenses.</p>
    }
  </div>

  <!-- SECTION 2: Add Expenses -->
  @if (users.length > 0) {
    <div class="section">
      <h2>ğŸ’³ Add Expense</h2>
      
      <div class="expense-form">
        <div class="form-group">
          <label>Description</label>
          <input 
            type="text" 
            [(ngModel)]="newExpense.description" 
            placeholder="e.g., Dinner, Movie tickets"
            class="input"
          />
        </div>

        <div class="form-group">
          <label>Amount (â‚¹)</label>
          <input 
            type="number" 
            [(ngModel)]="newExpense.amount" 
            placeholder="0.00"
            min="0"
            step="1"
            class="input"
          />
        </div>

        <div class="form-group">
          <label>Paid By</label>
          <select [(ngModel)]="newExpense.paidBy" class="input">
            <option value="">Select user</option>
            @for (user of users; track user.id) {
              <option [value]="user.id">{{ user.name }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label>Split Among</label>
          <div class="split-actions">
            <button (click)="selectAllUsers()" class="btn-link">Select All</button>
            <button (click)="deselectAllUsers()" class="btn-link">Deselect All</button>
          </div>
          <div class="checkbox-group">
            @for (user of users; track user.id) {
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  [checked]="isUserInSplit(user.id)"
                  (change)="toggleUserInSplit(user.id)"
                />
                <span>{{ user.name }}</span>
              </label>
            }
          </div>
        </div>

        <button (click)="addExpense()" class="btn btn-success btn-block">Add Expense</button>
      </div>
    </div>
  }

  <!-- SECTION 3: Expenses List -->
  @if (expenses.length > 0) {
    <div class="section">
      <div class="section-header">
        <h2>ğŸ“ Expenses ({{ expenses.length }})</h2>
        <button (click)="clearAllExpenses()" class="btn btn-danger-outline">Clear All</button>
      </div>

      <div class="total-expenses">
        Total: â‚¹{{ getTotalExpenses().toFixed(2) }}
      </div>

      <div class="expenses-list">
        @for (expense of expenses; track expense.id) {
          <div class="expense-card">
            <div class="expense-header">
              <h4>{{ expense.description }}</h4>
              <button (click)="removeExpense(expense.id)" class="btn-remove">Ã—</button>
            </div>
            <div class="expense-details">
              <div class="expense-amount"> â‚¹{{ expense.amount.toFixed(2) }}</div>
              <div class="expense-info">
                <div><strong>Paid by:</strong> {{ getExpensePaidBy(expense) }}</div>
                <div><strong>Split among:</strong> {{ getExpenseSplitNames(expense) }}</div>
                <div><strong>Per person:</strong>  â‚¹{{ (expense.amount / expense.splitAmong.length).toFixed(2) }}</div>
              </div>
            </div>
          </div>
        }
      </div>

      <button (click)="calculateSettlements()" class="btn btn-primary btn-block btn-large">
        ğŸ§® Calculate Settlements
      </button>
    </div>
  }

  <!-- SECTION 4: Settlement Results -->
  @if (showResults) {
    <div class="section results-section">
      <h2>ğŸ’¸ Settlement Summary</h2>

      <!-- Show Users List -->
      <div class="users-summary">
        <h3>ğŸ‘¥ Trip Members</h3>
        <div class="user-chip-list">
          @for (user of users; track user.id) {
            <span class="user-chip-display">{{ user.name }}</span>
          }
        </div>
      </div>

      <!-- User Balances -->
      <div class="balances-section">
        <h3>User Balances</h3>
        <div class="balance-grid">
          @for (user of users; track user.id) {
            <div class="balance-card">
              <div class="balance-name">{{ user.name }}</div>
              <div class="balance-amount" [ngClass]="getBalanceClass(getUserBalance(user.id))">
                â‚¹ {{ getUserBalance(user.id) > 0 ? '+' : '' }}  {{ getUserBalance(user.id).toFixed(2) }}
              </div>
              <div class="balance-label">
                @if (getUserBalance(user.id) > 0.01) {
                  <span class="label-positive">Gets back</span>
                } @else if (getUserBalance(user.id) < -0.01) {
                  <span class="label-negative">Owes</span>
                } @else {
                  <span class="label-neutral">Settled</span>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Settlements -->
      <div class="settlements-section">
        <h3>Who Pays Whom</h3>
        @if (settlements.length === 0) {
          <div class="settled-message">
            âœ… All settled! No payments needed.
          </div>
        } @else {
          <div class="settlement-list">
            @for (settlement of settlements; track $index; let i = $index) {
              <div class="settlement-item">
                <div class="settlement-number">{{ i + 1 }}</div>
                <div class="settlement-content">
                  <div class="settlement-from">{{ settlement.from }}</div>
                  <div class="settlement-arrow">â†’</div>
                  <div class="settlement-to">{{ settlement.to }}</div>
                </div>
                <div class="settlement-amount"> â‚¹ â†’ {{ settlement.amount.toFixed(2) }}</div>
              </div>
            }
          </div>
        }
      </div>

      <button (click)="resetCalculation()" class="btn btn-secondary btn-block">
        Back to Expenses
      </button>
    </div>
  }

  <!-- Empty State -->
  @if (users.length === 0 || expenses.length === 0) {
    <div class="empty-state">
      <div class="empty-icon">ğŸ“Š</div>
      @if (users.length === 0) {
        <h3>Get Started!</h3>
        <p>Add users above to start tracking expenses.</p>
      }
      @if (users.length > 0 && expenses.length === 0) {
        <h3>Add Your First Expense</h3>
        <p>Start by adding an expense above.</p>
      }
    </div>
  }
</div>